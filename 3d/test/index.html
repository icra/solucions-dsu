<!doctype html><html><head>
  <meta charset=utf8>
  <title>vista 3d</title>
  <style>
    body{
      margin:0;
    }
    #loading{
      background:linear-gradient(to left ,#af0,lightgreen);
      text-align:center;
      width:0;
      font-size:smaller;
      font-family:monospace;
    }
  </style>
</head><body>

<div>
  Arxius GLB:
  <a href="index.html?arxiu=gabions"           >gabions.glb</a> |
  <a href="index.html?arxiu=grapes"            >grapes.glb</a> |
  <a href="index.html?arxiu=malla_captacio"    >malla_captacio.glb</a> |
  <a href="index.html?arxiu=reixa_horitzontal" >reixa_horitzontal.glb</a> |
  <a href="index.html?arxiu=rototamis"         >rototamis.glb</a> |
  <a href="index.html?arxiu=tancs_modulars"    >tancs_modulars.glb</a> |
  <a href="index.html?arxiu=tancs"             >tancs.glb</a> |
</div>

<div>
  <div id=loading>carregant...</div>
</div>
<div id=app></div>

<script type="importmap">
  {
    "imports":{
      "three"        :"https://unpkg.com/three@v0.158.0/build/three.module.js",
      "three/addons/":"https://unpkg.com/three@v0.158.0/examples/jsm/"
    }
  }
</script>

<script>
  //globals
  let objecte; //objecte carregat
  let light; //llum
</script>

<script type=module>
  import * as THREE      from 'three';
  import {GLTFLoader}    from 'three/addons/loaders/GLTFLoader.js';
  import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

  //tamany canvas
  let w = window.innerWidth; //1600;//px
  let h = window.innerHeight;//1200;//px
  /**/

  //crea escena
  const scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xffffff));

  function create_light(x,y,z){
    let light = new THREE.DirectionalLight(0xffffff);
    light.position.set(x,y,z);
    scene.add(light);
  }
  create_light( 50, 50, 50);
  create_light( 50, 50,-50);
  create_light( 50,-50, 50);
  create_light( 50,-50,-50);
  create_light(-50, 50, 50);
  create_light(-50, 50,-50);
  create_light(-50,-50, 50);
  create_light(-50,-50,-50);
  /**/

  //crea camera
  const camera = new THREE.PerspectiveCamera(75, w/h, 0.1, 10000);
  camera.add(new THREE.PointLight(0xffffff,15));
  camera.position.x = 15;
  camera.position.y = 15;
  camera.position.z = 15;
  /**/

  /*crea renderer*/
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(w,h);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.querySelector("#app").appendChild(renderer.domElement);
  /**/

  /*mouse controls*/
  const controls = newÂ OrbitControls(camera,renderer.domElement);
  //controls.minDistance = 0.1;
  //controls.maxDistance = 7;
  controls.addEventListener('change',function(){
    /*
    console.log("camera.position",
      camera.position.x,
      camera.position.y,
      camera.position.z,
    );
    */
    //render();
  });
  /**/

  /*crea listener per resize window event*/
  /*
  window.addEventListener('resize',function(){
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
  }) ;
  */

  /*afegeix un fitxer 3d*/
  let glbLoader = new GLTFLoader();

  //paths arxius 3d
  let arxius={
    "gabions"           : "glb/gabions.glb",
    "grapes"            : "glb/grapes.glb",
    "malla_captacio"    : "glb/malla_captacio.glb",
    "reixa_horitzontal" : "glb/reixa_horitzontal.glb",
    "rototamis"         : "glb/rototamis.glb",
    "tancs_modulars"    : "glb/tancs_modulars.glb",
    "tancs"             : "glb/tancs.glb",
  };
  let arxiu_seleccionat = arxius["tancs"]; //per defecte

  //selecciona arxiu des de la URL
  let usp = new URLSearchParams(window.location.search);
  let usp_arxiu = usp.get("arxiu");
  if(usp_arxiu && arxius[usp_arxiu]){
    arxiu_seleccionat = arxius[usp_arxiu];
    console.log(`Carregant "${arxiu_seleccionat}"...`);
  }

  glbLoader.load(
    arxiu_seleccionat, //url arxiu
    //onload: called when loading is finished
    function(obj){
      objecte = obj.scene;

      if(false){
        objecte.position.z = -12;
        objecte.position.y = 557;
        objecte.position.x = 4;
      }

      scene.add(objecte);

      console.log({objecte_position:objecte.position});
      console.log({camera_position:camera.position});
      //document.querySelector("#loading").style.display="none";
    },
    //onprogress: called when loading is in progress
    function(xhr){
      if(xhr.loaded && xhr.total){
        let loaded = 100*xhr.loaded/xhr.total;
        let floor  = Math.floor(loaded);
        if(floor%10==0){
          console.log(`Carregant... ${floor}%`);
        }

        //loading indicator
        let el = document.querySelector("#loading");
        el.innerHTML=`${floor}%`;
        el.style.width=`${floor}%`;
      }
    },
    err=>console.log(err),
  );

  const axes = new THREE.AxesHelper(5);
  scene.add(axes);

  /*render loop*/
  function render(){
    renderer.render(scene,camera);
  }
  function animate(){
    requestAnimationFrame(animate);
    //objecte.position.z += 0.00001;
    //console.log(objecte.position.z);
    render();
  }
  animate();
  //render();
  /**/
</script>
